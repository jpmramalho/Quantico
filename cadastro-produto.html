<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Produto - Quantico</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h3>Quantico Menu</h3>
            </div>
            <nav>
                <ul>
                    <li class="has-submenu">
                        <a href="#" class="menu-toggle" id="produtoMenuToggle" data-target="submenu-produto">Produto</a>
                        <ul class="submenu" id="submenu-produto">
                            <li><a href="cadastro-produto.html">Cadastro</a></li>
                            <li><a href="localizar-produto.html">Localizar</a></li>
                            <li><a href="relatorio-produto.html">Relatório</a></li>
                        </ul>
                    </li>
                    <li><a href="#">CRM</a></li>
                    <li><a href="#">Usuário</a></li>
                    <li><a href="#" id="logoutButton">Sair</a></li>
                </ul>
            </nav>
        </aside>
        <main class="content">
            <div class="form-container">
                <h2 id="formTitle">Cadastro de Produto</h2>
                <form id="produtoForm">
                    <input type="hidden" id="productId"> <div class="form-group">
                        <label for="nome">Nome do Produto:</label>
                        <input type="text" id="nome" name="nome" required>
                    </div>
                    <div class="form-group">
                        <label for="preco">Preço:</label>
                        <input type="number" id="preco" name="preco" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="quantidade">Quantidade:</label>
                        <input type="number" id="quantidade" name="quantidade" required>
                    </div>
                    <div class="button-group">
                        <button type="submit" id="saveButton">Salvar</button>
                        <button type="button" id="newProductButton" style="display:none;">Novo Produto</button>
                        </div>
                </form>
            </div>
        </main>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="script.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Lógica para alternar submenus (mantido)
            document.querySelectorAll('.menu-toggle').forEach(button => {
                button.addEventListener('click', function(event) {
                    event.preventDefault();
                    const targetId = event.target.dataset.target;
                    const submenu = document.getElementById(targetId);

                    document.querySelectorAll('.submenu').forEach(sub => {
                        if (sub !== submenu && sub.classList.contains('active')) {
                            sub.classList.remove('active');
                            sub.style.maxHeight = null;
                        }
                    });

                    submenu.classList.toggle('active');
                    if (submenu.classList.contains('active')) {
                        submenu.style.maxHeight = submenu.scrollHeight + "px";
                    } else {
                        submenu.style.maxHeight = null;
                    }
                });
            });

            // Lógica para o botão de sair (mantido)
            document.getElementById('logoutButton').addEventListener('click', function() {
                if (window.auth) {
                    window.auth.signOut().then(() => {
                        window.location.href = 'index.html';
                    }).catch((error) => {
                        console.warn("Erro ao fazer logout do Firebase (pode não haver sessão ativa), redirecionando mesmo assim):", error);
                        window.location.href = 'index.html';
                    });
                } else {
                    window.location.href = 'index.html';
                }
            });

            const formTitle = document.getElementById('formTitle');
            const productIdField = document.getElementById('productId');
            const nomeInput = document.getElementById('nome');
            const precoInput = document.getElementById('preco');
            const quantidadeInput = document.getElementById('quantidade');
            const saveButton = document.getElementById('saveButton');
            const newProductButton = document.getElementById('newProductButton');
            const produtoForm = document.getElementById('produtoForm');

            // Função para carregar um produto para edição
            async function loadProductForEdit(productId) {
                if (!window.db) {
                    console.error("Firestore não inicializado.");
                    alert("Erro: O banco de dados não pôde ser acessado.");
                    return;
                }
                try {
                    const docRef = db.collection('produtos').doc(productId);
                    const doc = await docRef.get();

                    if (doc.exists) {
                        const productData = doc.data();
                        productIdField.value = doc.id; // Guarda o ID do produto
                        nomeInput.value = productData.nome;
                        precoInput.value = productData.preco;
                        quantidadeInput.value = productData.quantidade;

                        formTitle.textContent = 'Editar Produto';
                        saveButton.textContent = 'Atualizar';
                        newProductButton.style.display = 'inline-block'; // Mostra o botão "Novo Produto"
                    } else {
                        alert('Produto não encontrado para edição.');
                        console.warn("Produto não encontrado com ID:", productId);
                        // Se não encontrou, reseta o formulário para um novo cadastro
                        resetFormForNewProduct();
                    }
                } catch (error) {
                    console.error("Erro ao carregar produto para edição: ", error);
                    alert("Ocorreu um erro ao carregar o produto para edição. Verifique o console.");
                    resetFormForNewProduct(); // Em caso de erro, reseta
                }
            }

            // Função para resetar o formulário para um novo cadastro
            function resetFormForNewProduct() {
                produtoForm.reset();
                productIdField.value = '';
                formTitle.textContent = 'Cadastro de Produto';
                saveButton.textContent = 'Salvar';
                newProductButton.style.display = 'none'; // Esconde o botão "Novo Produto"
            }

            // Verifica se há um ID de produto na URL ao carregar a página
            const urlParams = new URLSearchParams(window.location.search);
            const productIdFromUrl = urlParams.get('id');
            if (productIdFromUrl) {
                loadProductForEdit(productIdFromUrl);
            } else {
                resetFormForNewProduct(); // Garante que o formulário está para cadastro se não houver ID
            }

            // Lógica para o botão "Novo Produto"
            newProductButton.addEventListener('click', function() {
                resetFormForNewProduct();
            });

            // Lógica para o formulário de Cadastro/Atualização
            produtoForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                const nome = nomeInput.value;
                const preco = parseFloat(precoInput.value);
                const quantidade = parseInt(quantidadeInput.value, 10);
                const productId = productIdField.value; // Pega o ID do campo oculto

                if (!nome || isNaN(preco) || isNaN(quantidade)) {
                    alert('Por favor, preencha todos os campos corretamente (nome, preço, quantidade).');
                    return;
                }
                if (!window.db) {
                    console.error("Firestore não inicializado.");
                    alert("Erro: O banco de dados não pôde ser acessado.");
                    return;
                }

                try {
                    if (productId) {
                        // Se há um productId, está editando um produto existente
                        await db.collection('produtos').doc(productId).update({
                            nome: nome,
                            preco: preco,
                            quantidade: quantidade,
                            // dataCadastro não é atualizada na edição, apenas no primeiro cadastro
                            dataAtualizacao: firebase.firestore.FieldValue.serverTimestamp() // Adiciona um timestamp de atualização
                        });
                        alert('Produto Atualizado com Sucesso!');
                    } else {
                        // Caso contrário, está cadastrando um novo produto
                        await db.collection('produtos').add({
                            nome: nome,
                            preco: preco,
                            quantidade: quantidade,
                            dataCadastro: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        alert('Produto Salvo com Sucesso!');
                        resetFormForNewProduct(); // Limpa o formulário para um novo cadastro
                    }

                } catch (error) {
                    console.error("Erro ao salvar/atualizar o produto no Firestore: ", error);
                    alert("Ocorreu um erro ao salvar/atualizar o produto. Verifique o console do navegador para mais detalhes e suas regras de segurança do Firestore.");
                }
            });
        });
    </script>
</body>
</html>